# Implementation Plan: Agent Notification System

**Branch**: `013-agent-notification-system` | **Date**: 2026-01-03 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/013-agent-notification-system/spec.md`

## Summary

Implement an Agent Notification System (ANS) that enables the system to communicate events (tool failures, budget warnings, loop detection) to the Oracle agent via TOON-formatted notifications. The system includes a file-based subscriber mechanism for modularity, a "system" role in the chat UI for distinct visual treatment, and a tabbed Settings page for subscriber management.

**Key Technical Decisions**:
- Use `python-toon` library for TOON encoding/decoding
- Jinja2 templates for notification formatting
- TOML config files for subscriber definitions
- Extend existing SSE stream with new "system" chunk type
- Add "system" role to frontend message rendering

## Technical Context

**Language/Version**: Python 3.11+ (backend), TypeScript 5.x (frontend)
**Primary Dependencies**: FastAPI, Pydantic, python-toon, Jinja2 (backend); React 18+, shadcn/ui (frontend)
**Storage**: SQLite (extend existing user_settings + context_nodes tables)
**Testing**: pytest (backend unit tests), manual E2E (frontend)
**Target Platform**: Linux server (Docker), Web browser
**Project Type**: Web application (monorepo with backend + frontend)
**Performance Goals**: <100ms event processing, 100 events/second throughput
**Constraints**: TOON format must achieve 40% token savings vs JSON
**Scale/Scope**: Single user (local mode), multi-user (HF Space)

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

| Principle | Status | Notes |
|-----------|--------|-------|
| I. Brownfield Integration | ✅ PASS | Extends existing oracle_agent.py, Settings.tsx |
| II. Test-Backed Development | ✅ PASS | pytest unit tests for ANS services planned |
| III. Incremental Delivery | ✅ PASS | Core subscribers first, then Settings UI |
| IV. Specification-Driven | ✅ PASS | All requirements traced to spec.md |
| No Magic | ✅ PASS | Explicit event types, file-based discovery |
| Single Source of Truth | ✅ PASS | Subscribers defined in TOML files |
| Error Handling | ✅ PASS | Template fallbacks, event queue limits |

## Project Structure

### Documentation (this feature)

```text
specs/013-agent-notification-system/
├── spec.md              # Feature specification
├── plan.md              # This file
├── research.md          # TOON, integration points research
├── data-model.md        # Event, Subscriber, Notification schemas
├── quickstart.md        # Developer getting started guide
├── contracts/           # API and event schemas
│   ├── openapi.yaml     # REST API contract
│   ├── events.yaml      # Event type definitions
│   └── subscriber-config.schema.json  # TOML config schema
├── checklists/
│   └── requirements.md  # Spec quality checklist
└── tasks.md             # Implementation tasks (generated by /speckit.tasks)
```

### Source Code (repository root)

```text
backend/
├── src/
│   ├── models/
│   │   ├── oracle.py           # MODIFY: Add StreamEventType.SYSTEM
│   │   ├── oracle_context.py   # MODIFY: Add ExchangeRole.SYSTEM
│   │   └── notifications.py    # NEW: Notification settings models
│   ├── services/
│   │   ├── ans/                # NEW: Agent Notification System package
│   │   │   ├── __init__.py
│   │   │   ├── bus.py          # Event bus (pub/sub)
│   │   │   ├── event.py        # Event dataclass
│   │   │   ├── subscriber.py   # Subscriber loader + protocol
│   │   │   ├── accumulator.py  # Batching, deduplication
│   │   │   ├── toon_formatter.py  # TOON + Jinja2
│   │   │   ├── subscribers/    # Subscriber TOML configs
│   │   │   │   ├── tool_failure.toml
│   │   │   │   ├── budget_warning.toml
│   │   │   │   ├── budget_exceeded.toml
│   │   │   │   └── loop_detected.toml
│   │   │   └── templates/      # Jinja2 TOON templates
│   │   │       ├── tool_failure.toon.j2
│   │   │       ├── budget_warning.toon.j2
│   │   │       ├── budget_exceeded.toon.j2
│   │   │       └── loop_detected.toon.j2
│   │   ├── oracle_agent.py     # MODIFY: Emit events, inject notifications
│   │   ├── tool_executor.py    # MODIFY: Emit tool events
│   │   └── user_settings.py    # MODIFY: Notification settings
│   └── api/
│       └── routes/
│           ├── models.py       # MODIFY: Add notification settings endpoints
│           └── notifications.py # NEW: Subscriber management endpoints
└── tests/
    └── unit/
        ├── test_ans_bus.py     # NEW: Event bus tests
        ├── test_ans_subscriber.py  # NEW: Subscriber tests
        ├── test_ans_accumulator.py # NEW: Batching tests
        └── test_toon_formatter.py  # NEW: TOON formatting tests

frontend/
├── src/
│   ├── types/
│   │   ├── oracle.ts           # MODIFY: Add 'system' role
│   │   ├── rag.ts              # MODIFY: Add 'system' to Role
│   │   └── notifications.ts    # NEW: Subscriber types
│   ├── services/
│   │   └── notifications.ts    # NEW: API client
│   ├── components/
│   │   ├── ui/
│   │   │   └── tabs.tsx        # NEW: shadcn/ui Tabs component
│   │   ├── ChatPanel.tsx       # MODIFY: Handle 'system' chunks
│   │   ├── ChatMessage.tsx     # MODIFY: System message styling
│   │   └── NotificationSettings.tsx  # NEW: Subscriber toggles
│   └── pages/
│       └── Settings.tsx        # MODIFY: Add Notifications tab
└── tests/
    # Manual E2E testing
```

**Structure Decision**: Web application structure following existing monorepo conventions.

## Integration Points (Detailed)

### Backend Integration

#### 1. Event Emission Points

| Location | Line | Event Type | Trigger |
|----------|------|------------|---------|
| `oracle_agent.py` | ~423 | `agent.turn.start` | Turn loop begins |
| `oracle_agent.py` | ~704 | `agent.turn.end` | Turn loop completes |
| `oracle_agent.py` | ~491-499 | `budget.*.warning` | Threshold crossed |
| `oracle_agent.py` | ~928-936 | `tool.call.pending` | Before execution |
| `oracle_agent.py` | ~964 | `tool.call.success` | After success |
| `oracle_agent.py` | ~1043-1051 | `tool.call.failure` | On error |
| `tool_executor.py` | ~240-261 | `tool.call.timeout` | Timeout handler |

#### 2. Notification Injection Points

```python
# oracle_agent.py pseudo-code

async def run_turn_loop(...):
    # INJECTION POINT 1: turn_start
    notifications = self._ans_accumulator.drain("turn_start")
    if notifications:
        yield OracleStreamChunk(type="system", content=notifications)

    # ... tool execution ...

    for tool_result in results:
        # INJECTION POINT 2: after_tool
        notifications = self._ans_accumulator.drain("after_tool")
        if notifications:
            yield OracleStreamChunk(type="system", content=notifications)

    # INJECTION POINT 3: turn_end
    notifications = self._ans_accumulator.drain("turn_end")
    if notifications:
        yield OracleStreamChunk(type="system", content=notifications)
```

#### 3. SSE Stream Extension

```python
# models/oracle.py

class StreamEventType(str, Enum):
    STATUS = "status"
    THINKING = "thinking"
    CONTENT = "content"
    TOOL_CALL = "tool_call"
    TOOL_RESULT = "tool_result"
    SOURCES = "sources"
    ERROR = "error"
    DONE = "done"
    SYSTEM = "system"  # NEW
```

### Frontend Integration

#### 1. Type Extensions

```typescript
// types/oracle.ts
export interface OracleMessage {
  role: 'user' | 'assistant' | 'system';  // Add 'system'
  // ...
}

// types/rag.ts
export type Role = 'user' | 'assistant' | 'system';  // Add 'system'
```

#### 2. ChatPanel.tsx SSE Handler

```typescript
// Around line 549 in streamOracle callback
case 'system':
  const systemMsg: OracleMessageWithId = {
    _id: `sys_${Date.now()}`,
    role: 'system',
    content: chunk.content,
    timestamp: new Date().toISOString(),
  };
  setMessages(prev => [...prev, systemMsg]);
  break;
```

#### 3. ChatMessage.tsx Styling

```typescript
// Line 41
const isUser = message.role === 'user';
const isSystem = message.role === 'system';

// Avatar (lines 210-215)
<div className={cn(
  "h-8 w-8 rounded-full flex items-center justify-center",
  isUser ? "bg-primary text-primary-foreground" :
  isSystem ? "bg-yellow-500/20 text-yellow-700 dark:text-yellow-300 border border-yellow-500/30" :
  "bg-secondary text-secondary-foreground"
)}>
  {isUser ? <User /> : isSystem ? <AlertCircle /> : <Bot />}
</div>

// Container (line 208)
<div className={cn(
  "flex gap-3 p-4",
  isUser ? "bg-transparent" :
  isSystem ? "bg-yellow-500/5 border-l-2 border-yellow-500/30" :
  "bg-muted/30"
)}>
```

#### 4. Settings.tsx Tabbed Interface

```typescript
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';

// In render:
<Tabs defaultValue="account">
  <TabsList>
    <TabsTrigger value="account">Account</TabsTrigger>
    <TabsTrigger value="models">AI Models</TabsTrigger>
    <TabsTrigger value="context">Context</TabsTrigger>
    <TabsTrigger value="notifications">Notifications</TabsTrigger>
  </TabsList>

  <TabsContent value="notifications">
    <NotificationSettings />
  </TabsContent>
</Tabs>
```

## Database Changes

### user_settings table (extend)

```sql
ALTER TABLE user_settings
ADD COLUMN disabled_subscribers_json TEXT DEFAULT '[]';
```

### context_nodes table (extend)

```sql
ALTER TABLE context_nodes
ADD COLUMN system_messages_json TEXT DEFAULT '[]';
```

## Core Subscriber Configurations

### tool_failure.toml

```toml
[subscriber]
id = "tool_failure"
name = "Tool Failure Notifications"
description = "Notifies agent when tool calls fail or timeout"
version = "1.0.0"

[events]
types = ["tool.call.failure", "tool.call.timeout"]
severity_filter = "warning"

[batching]
window_ms = 2000
max_size = 10
dedupe_key = "type:payload.tool_name"
dedupe_window_ms = 5000

[output]
priority = "high"
inject_at = "after_tool"
template = "tool_failure.toon.j2"
core = true
```

### budget_warning.toml

```toml
[subscriber]
id = "budget_warning"
name = "Budget Warning Notifications"
description = "Warns agent when approaching resource limits"
version = "1.0.0"

[events]
types = ["budget.token.warning", "budget.iteration.warning", "budget.timeout.warning"]
severity_filter = "warning"

[batching]
window_ms = 0
dedupe_window_ms = 10000

[output]
priority = "high"
inject_at = "turn_start"
template = "budget_warning.toon.j2"
core = true
```

### budget_exceeded.toml

```toml
[subscriber]
id = "budget_exceeded"
name = "Budget Exceeded Notifications"
description = "Notifies agent when resource limits are reached"
version = "1.0.0"

[events]
types = ["budget.token.exceeded", "budget.iteration.exceeded"]
severity_filter = "critical"

[batching]
window_ms = 0

[output]
priority = "critical"
inject_at = "immediate"
template = "budget_exceeded.toon.j2"
core = true
```

### loop_detected.toml

```toml
[subscriber]
id = "loop_detected"
name = "Loop Detection Notifications"
description = "Notifies agent when stuck in repetitive pattern"
version = "1.0.0"

[events]
types = ["agent.loop.detected"]
severity_filter = "warning"

[batching]
window_ms = 0
dedupe_window_ms = 30000

[output]
priority = "high"
inject_at = "turn_start"
template = "loop_detected.toon.j2"
core = true
```

## TOON Template Examples

### tool_failure.toon.j2

```jinja
{% if events|length == 1 %}
tool_fail: {{ events[0].payload.tool_name }} {{ events[0].payload.error_type }}{% if events[0].payload.error_message %} - {{ events[0].payload.error_message }}{% endif %}

{% else %}
tool_fails[{{ events|length }}]{tool,error,message}:
{% for e in events %}
  {{ e.payload.tool_name }},{{ e.payload.error_type }},{{ e.payload.error_message | default("") }}
{% endfor %}
{% endif %}
```

### budget_warning.toon.j2

```jinja
{% if events|length == 1 %}
{% set e = events[0] %}
{% if e.type == "budget.token.warning" %}
!warning: {{ e.payload.percentage }}% tokens consumed ({{ e.payload.current }}/{{ e.payload.limit }})
{% elif e.type == "budget.iteration.warning" %}
!warning: {{ e.payload.percentage }}% iterations used ({{ e.payload.current }}/{{ e.payload.limit }})
{% elif e.type == "budget.timeout.warning" %}
!warning: {{ e.payload.remaining_seconds }}s remaining before timeout
{% endif %}
{% else %}
budget_warnings[{{ events|length }}]{type,percentage,remaining}:
{% for e in events %}
  {{ e.type | replace("budget.", "") | replace(".warning", "") }},{{ e.payload.percentage }},{{ e.payload.remaining }}
{% endfor %}
{% endif %}
```

## Complexity Tracking

| Aspect | Complexity | Justification |
|--------|------------|---------------|
| New package (ans/) | Medium | Required for modularity; follows existing service pattern |
| TOON library | Low | Well-documented, single dependency |
| Jinja2 templates | Low | Already used in project (oracle prompts) |
| SSE extension | Low | Adding one new chunk type |
| Settings UI tabs | Medium | Refactoring existing page |

No constitution violations.

## Dependencies to Add

### Backend (pyproject.toml)

```toml
dependencies = [
    # ... existing
    "python-toon>=0.9.0",
]
```

### Frontend

```bash
# Add shadcn/ui tabs component
npx shadcn@latest add tabs
```

## Risk Mitigation

| Risk | Mitigation |
|------|------------|
| TOON library beta | Pin version, add fallback to JSON if parsing fails |
| Template rendering errors | Catch exceptions, use generic fallback message |
| Event flood | Queue with max size, drop oldest low-priority |
| Context overflow | Summarize old notifications instead of dropping |

## Phase Summary

1. **Phase 0** ✅: Research complete (research.md)
2. **Phase 1** ✅: Design complete (data-model.md, contracts/)
3. **Phase 2** (next): Generate tasks.md via `/speckit.tasks`
