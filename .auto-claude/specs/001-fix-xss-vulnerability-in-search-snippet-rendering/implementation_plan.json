{
  "feature": "Fix XSS vulnerability in search snippet rendering",
  "description": "The SearchWidget component uses `dangerouslySetInnerHTML` to render search result snippets without sanitization. Search snippets are generated by SQLite FTS5's snippet() function which wraps matches in <mark> tags, but the underlying note content is user-generated and could contain malicious HTML/JavaScript that gets executed in the browser.",
  "created_at": "2026-01-01T13:20:00.480Z",
  "updated_at": "2026-01-01T13:30:00.000Z",
  "status": "in_progress",
  "planStatus": "approved",
  "workflow_type": "development",
  "services_involved": ["backend", "frontend"],
  "spec_file": "spec.md",
  "phases": [
    {
      "phase_id": "phase-1",
      "name": "Backend Sanitization",
      "description": "Add HTML sanitization utility to escape all HTML in snippets except the FTS5-generated <mark> tags",
      "status": "completed",
      "subtasks": [
        {
          "subtask_id": "1.1",
          "title": "Create snippet sanitizer utility",
          "description": "Create a new utility function `sanitize_snippet()` in backend/src/services/sanitizer.py that:\n1. HTML-escapes the entire snippet first (converting <, >, &, etc. to entities)\n2. Restores only the legitimate FTS5-generated <mark> and </mark> tags\n3. Handles edge cases like nested/malformed tags",
          "files_to_create": ["backend/src/services/sanitizer.py"],
          "files_to_modify": [],
          "estimated_effort": "small",
          "status": "completed",
          "notes": "Created sanitize_snippet() function with html.escape() + mark tag restoration. Handles all edge cases including nested tags, malformed tags, and event handlers."
        },
        {
          "subtask_id": "1.2",
          "title": "Integrate sanitizer into indexer search",
          "description": "Modify IndexerService.search_notes() in backend/src/services/indexer.py to sanitize snippets before returning them. Import and apply sanitize_snippet() to the snippet field in the results list.",
          "files_to_create": [],
          "files_to_modify": ["backend/src/services/indexer.py"],
          "estimated_effort": "small",
          "status": "completed",
          "notes": "Successfully integrated sanitize_snippet() into IndexerService.search_notes(). All search snippets are now HTML-escaped except for FTS5-generated <mark> tags, preventing XSS attacks while preserving search highlighting."
        },
        {
          "subtask_id": "1.3",
          "title": "Add unit tests for sanitizer",
          "description": "Create unit tests in backend/tests/unit/test_sanitizer.py that verify:\n1. Normal text passes through unchanged (except HTML escaping)\n2. <mark>...</mark> tags are preserved\n3. Malicious <script> tags are escaped\n4. Other HTML tags (<a>, <img>, <div>, etc.) are escaped\n5. Event handlers (onerror, onclick, etc.) are escaped\n6. Edge cases: nested marks, unclosed tags, entities in content",
          "files_to_create": ["backend/tests/unit/test_sanitizer.py"],
          "files_to_modify": [],
          "estimated_effort": "medium",
          "status": "completed",
          "notes": "Created comprehensive unit tests in backend/tests/unit/test_sanitizer.py with 30+ test cases covering normal text, mark tag preservation, malicious scripts, HTML tags, event handlers, and edge cases. All tests validate sanitize_snippet() prevents XSS while preserving search highlighting."
        }
      ]
    },
    {
      "phase_id": "phase-2",
      "name": "Frontend Sanitization (Defense in Depth)",
      "description": "Replace dangerouslySetInnerHTML with safe React-based rendering that parses and safely renders only <mark> tags",
      "status": "completed",
      "subtasks": [
        {
          "subtask_id": "2.1",
          "title": "Create SafeSnippet component",
          "description": "Create frontend/src/components/SafeSnippet.tsx that:\n1. Parses the snippet string to extract text and <mark> boundaries\n2. Renders using React elements (text nodes and <mark> elements)\n3. Does NOT use dangerouslySetInnerHTML\n4. Handles edge cases like unclosed tags gracefully",
          "files_to_create": ["frontend/src/components/SafeSnippet.tsx"],
          "files_to_modify": [],
          "estimated_effort": "small",
          "status": "completed",
          "notes": "Created SafeSnippet.tsx component that safely parses and renders search snippets with <mark> tags. The component uses programmatic parsing (split by tags) and renders using React elements instead of dangerouslySetInnerHTML. Handles edge cases like unclosed tags gracefully by treating remaining content as highlighted. Provides defense-in-depth against XSS by only rendering text nodes and <mark> elements."
        },
        {
          "subtask_id": "2.2",
          "title": "Update SearchWidget to use SafeSnippet",
          "description": "Modify frontend/src/components/SearchWidget.tsx to:\n1. Import SafeSnippet component\n2. Replace dangerouslySetInnerHTML with SafeSnippet\n3. Remove the unsafe HTML rendering entirely",
          "files_to_create": [],
          "files_to_modify": ["frontend/src/components/SearchWidget.tsx"],
          "estimated_effort": "small",
          "status": "completed",
          "notes": "Successfully replaced dangerouslySetInnerHTML with SafeSnippet component in SearchWidget.tsx. The component now safely renders search snippets using the SafeSnippet component which programmatically parses and renders only text nodes and <mark> elements. This eliminates the XSS vulnerability while preserving search result highlighting. Changes include: (1) Imported SafeSnippet component, (2) Replaced <p> element with dangerouslySetInnerHTML with SafeSnippet component, (3) Maintained same styling with className prop."
        }
      ]
    },
    {
      "phase_id": "phase-3",
      "name": "Integration Testing & Verification",
      "description": "Verify the fix works end-to-end and doesn't break existing functionality",
      "status": "pending",
      "subtasks": [
        {
          "subtask_id": "3.1",
          "title": "Add integration test for search sanitization",
          "description": "Create backend/tests/integration/test_search_sanitization.py that:\n1. Creates a note with malicious content (script tags, event handlers)\n2. Indexes the note\n3. Searches for content\n4. Verifies the returned snippet is properly sanitized\n5. Verifies <mark> highlighting still works",
          "files_to_create": ["backend/tests/integration/test_search_sanitization.py"],
          "files_to_modify": [],
          "estimated_effort": "medium",
          "status": "completed",
          "notes": "Created comprehensive integration tests with 10 test cases covering end-to-end sanitization flow. Tests verify: (1) Script tags are escaped in search results, (2) Event handlers are escaped, (3) Multiple XSS vectors are all sanitized, (4) FTS5 <mark> highlighting works correctly, (5) HTML content and search highlighting coexist properly, (6) Special characters are escaped, (7) Multi-user isolation works. All tests follow existing patterns from test_indexer_search.py and use proper fixtures with temporary databases."
        },
        {
          "subtask_id": "3.2",
          "title": "Run test suite and verify no regressions",
          "description": "Run the full backend test suite (uv run pytest) to ensure:\n1. All new tests pass\n2. No existing tests are broken\n3. Search functionality works correctly with sanitized snippets",
          "files_to_create": [],
          "files_to_modify": [],
          "estimated_effort": "small",
          "status": "pending",
          "notes": ""
        }
      ]
    }
  ],
  "qa_signoff": {
    "status": "pending",
    "tests_passed": "",
    "issues": ""
  },
  "final_acceptance": [
    "All malicious HTML/JavaScript in snippets is escaped",
    "FTS5 <mark> highlighting still works correctly",
    "No dangerouslySetInnerHTML usage for user content",
    "All tests pass"
  ]
}
