# Build Progress: Fix XSS Vulnerability in Search Snippet Rendering

## Status: In Progress

## Summary
The SearchWidget component in the frontend uses `dangerouslySetInnerHTML` to render
search snippets, which creates an XSS vulnerability since note content is user-generated.

## Vulnerability Details
- **Location**: `frontend/src/components/SearchWidget.tsx:37`
- **Issue**: SQLite FTS5 snippet() wraps matches in <mark> tags but preserves all user content
- **Risk**: Malicious scripts/HTML in notes could execute in browser when searching

## Implementation Plan (3 Phases, 7 Subtasks)

### Phase 1: Backend Sanitization
- [x] 1.1 Create snippet sanitizer utility
  - Created `backend/src/services/sanitizer.py` with `sanitize_snippet()` function
  - Uses html.escape() to sanitize all HTML, then restores only <mark> tags
  - Handles edge cases: nested tags, malformed tags, event handlers
  - Commit: b890ae5
- [ ] 1.2 Integrate sanitizer into indexer search
- [ ] 1.3 Add unit tests for sanitizer

### Phase 2: Frontend Sanitization (Defense in Depth)
- [ ] 2.1 Create SafeSnippet component
- [ ] 2.2 Update SearchWidget to use SafeSnippet

### Phase 3: Integration Testing & Verification
- [ ] 3.1 Add integration test for search sanitization
- [ ] 3.2 Run test suite and verify no regressions

## Technical Approach
1. **Backend**: HTML-escape all content, then restore only FTS5's `<mark>` and `</mark>` tags
2. **Frontend**: Parse snippet and render with React elements (no dangerouslySetInnerHTML)
3. **Testing**: Unit tests for sanitizer + integration test with malicious content

## Files to Create
- `backend/src/services/sanitizer.py`
- `backend/tests/unit/test_sanitizer.py`
- `backend/tests/integration/test_search_sanitization.py`
- `frontend/src/components/SafeSnippet.tsx`

## Files to Modify
- `backend/src/services/indexer.py`
- `frontend/src/components/SearchWidget.tsx`

---
Last Updated: 2026-01-01
