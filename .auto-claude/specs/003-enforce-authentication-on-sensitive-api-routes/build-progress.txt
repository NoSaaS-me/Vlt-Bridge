# Build Progress: 003-enforce-authentication-on-sensitive-api-routes

## Session: 2026-01-01

### Analysis Complete

Performed comprehensive codebase analysis to understand the authentication landscape:

#### Key Findings:

1. **Primary Vulnerability: ENABLE_NOAUTH_MCP bypass**
   - Located in `backend/src/api/middleware/auth_middleware.py`
   - When `ENABLE_NOAUTH_MCP=true`, the `get_auth_context` dependency returns a "demo-user" context without requiring any Authorization header
   - This affects ALL routes that use `get_auth_context` as a dependency

2. **Routes Analyzed:**
   - `notes.py` - CRUD operations on user notes
   - `index.py` - Index rebuild (administrative)
   - `oracle.py` - LLM queries (consumes OpenRouter credits)
   - `oracle_context.py` - Context tree management
   - `threads.py` - Development history/reasoning chains
   - `rag.py` - RAG chat (consumes LLM resources)
   - `tts.py` - Text-to-speech (consumes ElevenLabs API)
   - `search.py` - Full-text search, backlinks, tags
   - `graph.py` - Note relationship graph
   - `system.py` - System logs (security sensitive)
   - `auth.py` - Token issuance, user profile
   - `demo.py` - Demo token issuance (intentionally public)

3. **MCP Server Analysis:**
   - Located in `backend/src/mcp/server.py`
   - Has its own `_current_user_id()` function
   - Also has ENABLE_NOAUTH_MCP bypass for HTTP transport
   - STDIO transport correctly falls back to local-dev (acceptable for local execution)

4. **Current Protection Patterns:**
   - Some routes check `_ensure_write_allowed(user_id)` to prevent demo-user writes
   - This doesn't prevent unauthenticated access - just prevents modifications
   - Read access to all user data is still possible

#### Implementation Plan Created:

Created comprehensive implementation_plan.json with 4 phases:

- **Phase 1**: Create foundational auth dependencies (require_auth_context, require_admin_context, AuthMode enum)
- **Phase 2**: Update all sensitive routes (10 subtasks covering all route files)
- **Phase 3**: Secure MCP HTTP endpoint, add documentation and warnings
- **Phase 4**: Testing and validation (unit tests, integration tests, manual testing)

Total subtasks: 17

### Next Steps:

Begin implementation with Phase 1, starting with P1.1 (Create strict authentication dependency).

---

## Session: 2026-01-01 (Implementation)

### ✅ P1.1 - Create strict authentication dependency (COMPLETED)

**Implementation Details:**
- Created new `require_auth_context()` function in `backend/src/api/middleware/auth_middleware.py`
- Function enforces strict authentication without any fallback to demo-user
- Validates JWT tokens and raises 401 Unauthorized if no valid Authorization header is present
- Implementation follows same pattern as `get_auth_context()` but removes the ENABLE_NOAUTH_MCP bypass logic
- Added comprehensive docstring explaining when to use this dependency
- Added to `__all__` exports for use in route dependencies

**Key Differences from get_auth_context:**
- `get_auth_context()`: Falls back to "demo-user" when ENABLE_NOAUTH_MCP=true
- `require_auth_context()`: ALWAYS requires valid Authorization header, regardless of config

**Verification:**
- Code follows existing patterns in auth_middleware.py
- Uses same error handling structure (_unauthorized helper)
- Returns AuthContext dataclass with user_id, token, and payload
- Properly handles AuthError exceptions from auth_service.validate_jwt()

**Files Modified:**
- backend/src/api/middleware/auth_middleware.py

**Commit:** 7edbe79

**Status:** Ready for use in Phase 2 route protection subtasks

---

### ✅ P1.2 - Create admin-only authentication dependency (COMPLETED)

**Implementation Details:**
- Added `admin_user_ids` field to `AppConfig` in `backend/src/services/config.py`
  - Type: `set[str]` with default empty set
  - Parsed from `ADMIN_USER_IDS` environment variable (comma-separated list)
  - Parsing logic strips whitespace and filters empty strings
- Created new `require_admin_context()` function in `backend/src/api/middleware/auth_middleware.py`
  - First enforces strict authentication by calling `require_auth_context()`
  - Then checks if authenticated user_id is in admin_user_ids set
  - Raises 401 Unauthorized if no valid Authorization header (from require_auth_context)
  - Raises 403 Forbidden if user lacks admin privileges
  - Returns AuthContext if user is authenticated AND has admin privileges
- Added `_forbidden()` helper function for consistent 403 error responses
- Added comprehensive docstring explaining when to use this dependency (system logs, user management, etc.)
- Added to `__all__` exports for use in route dependencies

**Key Features:**
- Two-stage validation: authentication first, then authorization
- Clear separation of concerns (401 for auth failure, 403 for insufficient permissions)
- Follows existing code patterns in auth_middleware.py
- Environment variable configuration allows easy admin user management

**Configuration:**
```bash
# Example: Set admin users in .env
ADMIN_USER_IDS="user-123,admin-user,john@example.com"
```

**Verification:**
- Python syntax check passed
- Code follows existing patterns
- Proper error handling with specific error codes
- Documentation clear and complete

**Files Modified:**
- backend/src/services/config.py (added admin_user_ids field and parsing)
- backend/src/api/middleware/auth_middleware.py (added require_admin_context and _forbidden helper)

**Commit:** 23edc9c

**Status:** Ready for use in P2.9 (Protect system routes with admin auth)

---

### ✅ P1.3 - Add authentication mode enum and helper (COMPLETED)

**Implementation Details:**
- Created `AuthMode` enum in `backend/src/api/middleware/auth_middleware.py`
  - Three authentication levels: `OPTIONAL`, `STRICT`, `ADMIN`
  - Each mode has clear semantics documented in docstring
  - OPTIONAL: Falls back to demo-user when ENABLE_NOAUTH_MCP=true
  - STRICT: Always requires valid Authorization header
  - ADMIN: Requires valid Authorization header + admin privileges
- Created `get_auth_dependency()` factory function
  - Takes `AuthMode` as parameter
  - Returns the appropriate dependency function based on mode
  - OPTIONAL → `get_auth_context`
  - STRICT → `require_auth_context`
  - ADMIN → `require_admin_context`
  - Raises `ValueError` for unknown auth modes
- Added comprehensive docstring with usage examples for all three modes
- Updated imports to include `Enum` and `Callable` types
- Updated `__all__` exports to include `AuthMode` and `get_auth_dependency`

**Key Benefits:**
- More explicit and type-safe authentication requirement declaration
- Routes can use: `auth: AuthContext = Depends(get_auth_dependency(AuthMode.STRICT))`
- Easier to understand authentication requirements at a glance
- Provides a centralized, consistent pattern for authentication
- Alternative to importing different dependency functions

**Usage Example:**
```python
from fastapi import Depends
from ..middleware import AuthContext, AuthMode, get_auth_dependency

@router.get("/api/notes")
async def list_notes(
    auth: AuthContext = Depends(get_auth_dependency(AuthMode.STRICT))
):
    # This route requires strict authentication
    ...

@router.get("/api/system/logs")
async def get_logs(
    auth: AuthContext = Depends(get_auth_dependency(AuthMode.ADMIN))
):
    # This route requires admin privileges
    ...
```

**Verification:**
- Python syntax check passed (py_compile)
- Code follows existing patterns in auth_middleware.py
- Proper type hints with Callable return type
- Clear documentation with examples
- All three enum values map to correct dependency functions

**Files Modified:**
- backend/src/api/middleware/auth_middleware.py

**Commit:** e5c8fd2

**Status:** Phase 1 (Foundational Security Improvements) complete! Ready to begin Phase 2 (Protect Sensitive Routes)
