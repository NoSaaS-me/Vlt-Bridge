{
  "feature": "Add hover preview cards for wikilinks",
  "description": "Enhance HoverCard popups that show a preview of linked notes when hovering over wikilinks in the NoteViewer, similar to Wikipedia's preview feature. The current implementation exists but uses inefficient search-based resolution. This plan adds a dedicated API and improves the preview card UI.",
  "created_at": "2026-01-01T13:24:23.485Z",
  "updated_at": "2026-01-01T15:30:00.000Z",
  "status": "in_progress",
  "planStatus": "in_progress",
  "workflow_type": "development",
  "services_involved": [
    "backend",
    "frontend"
  ],
  "phases": [
    {
      "id": "phase-1",
      "name": "Backend API Enhancements",
      "description": "Add dedicated endpoints for wikilink resolution and note preview to improve performance and accuracy",
      "status": "completed",
      "subtasks": [
        {
          "id": "1.1",
          "title": "Add wikilink resolution endpoint",
          "description": "Create GET /api/wikilinks/resolve?link={linkText} endpoint that uses IndexerService.resolve_wikilinks() to accurately resolve a wikilink to its target note path using slug-based matching",
          "status": "completed",
          "notes": "\u2713 Added IndexerService.resolve_single_wikilink() method\n\u2713 Created GET /api/wikilinks/resolve endpoint  \n\u2713 Added WikilinkResolution response model\n\u2713 Follows existing code patterns (auth, error handling, URL decoding)\n\u2713 Uses slug-based matching with same-folder preference\n\u2713 Committed: 737dc43",
          "files": [
            "backend/src/api/routes/search.py"
          ],
          "updated_at": "2026-01-01T13:29:46.193466+00:00"
        },
        {
          "id": "1.2",
          "title": "Add note preview endpoint",
          "description": "Create GET /api/notes/{path}/preview endpoint that returns lightweight preview data: title, first 200 chars of body (stripped of markdown), tags array, and updated timestamp",
          "status": "completed",
          "notes": "\u2713 Added NotePreview model to backend/src/models/note.py with title, snippet, tags, and updated fields\n\u2713 Created _strip_markdown() helper function to remove markdown formatting\n\u2713 Implemented GET /api/notes/{path}/preview endpoint in backend/src/api/routes/notes.py\n\u2713 Endpoint returns lightweight preview data: title, first 200 chars (markdown stripped), tags array, and updated timestamp\n\u2713 Follows existing code patterns (auth, error handling, URL decoding)\n\u2713 Gets tags from metadata first, falls back to database query\n\u2713 Properly handles timestamps with same parsing logic as other endpoints\n\u2713 Committed: 07ff27e",
          "files": [
            "backend/src/api/routes/notes.py",
            "backend/src/models/note.py"
          ],
          "updated_at": "2026-01-01T13:32:35.021040+00:00"
        },
        {
          "id": "1.3",
          "title": "Add unit tests for new endpoints",
          "description": "Write pytest tests for the wikilink resolution and preview endpoints covering happy path, 404 cases, and edge cases",
          "status": "completed",
          "notes": "\u2713 Created comprehensive test suite in backend/tests/unit/test_wikilink_api.py\n\u2713 17 test cases covering both endpoints with fixtures and mocks\n\u2713 Wikilink resolution tests (7): success, context, broken links, validation, URL decoding, errors\n\u2713 Note preview tests (10): success, markdown stripping, tags, 404, URL decoding, errors, edge cases\n\u2713 Follows existing test patterns (TestClient, fixtures, mocks, dependency overrides)\n\u2713 Syntax validation passed\n\u2713 Committed: f3fbafb",
          "files": [
            "backend/tests/unit/test_wikilink_api.py"
          ],
          "updated_at": "2026-01-01T13:35:48.838278+00:00"
        }
      ]
    },
    {
      "id": "phase-2",
      "name": "Frontend API Integration",
      "description": "Update frontend API service and WikilinkPreview component to use new backend endpoints",
      "status": "pending",
      "subtasks": [
        {
          "id": "2.1",
          "title": "Add API service functions",
          "description": "Add resolveWikilink(linkText) and getNotePreview(path) functions to frontend/src/services/api.ts with proper TypeScript types",
          "status": "completed",
          "notes": "\u2713 Added WikilinkResolution and NotePreview interfaces to frontend/src/types/note.ts\n\u2713 Added resolveWikilink(linkText, contextPath?) function to frontend/src/services/api.ts\n\u2713 Added getNotePreview(path) function to frontend/src/services/api.ts\n\u2713 Both functions follow existing code patterns (apiFetch, URL encoding, JSDoc comments)\n\u2713 Types match backend models (WikilinkResolution from search.py, NotePreview from note.py)\n\u2713 Committed: 83398ad",
          "files": [
            "frontend/src/services/api.ts",
            "frontend/src/types/note.ts"
          ],
          "updated_at": "2026-01-01T13:38:20.875161+00:00"
        },
        {
          "id": "2.2",
          "title": "Refactor WikilinkPreview to use resolution API",
          "description": "Update WikilinkPreview component in markdown.tsx to first resolve wikilink text to path using new API, then fetch preview. Handle broken links (resolution returns null)",
          "status": "completed",
          "notes": "\u2713 Updated WikilinkPreview component to use new resolution API\n\u2713 Changed imports to use resolveWikilink and getNotePreview\n\u2713 Updated preview state and cache to use NotePreview type\n\u2713 Refactored fetchPreview function to:\n  - First call resolveWikilink() to get target path\n  - Handle broken links (is_resolved=false or null target_path)\n  - Then call getNotePreview() with resolved path\n  - Cache NotePreview object instead of plain string\n\u2713 Updated rendering to use preview.snippet\n\u2713 Follows existing code patterns and TypeScript conventions\n\u2713 Committed: e54a75f",
          "files": [
            "frontend/src/lib/markdown.tsx"
          ],
          "updated_at": "2026-01-01T13:40:37.075224+00:00"
        },
        {
          "id": "2.3",
          "title": "Update preview cache strategy",
          "description": "Separate caches for resolution (linkText -> path) and previews (path -> previewData). Resolution cache can be longer-lived since paths rarely change",
          "status": "completed",
          "notes": "\u2713 Separated caches into two distinct stores with different purposes:\n  - resolutionCache: Map<string, string | null> - maps linkText to resolved path (longer-lived)\n  - previewCache: Map<string, NotePreview> - maps path to preview data (can be invalidated more frequently)\n\n\u2713 Updated fetchPreview logic to use two-stage caching:\n  1. Check resolutionCache for linkText \u2192 path, fetch and cache if missing\n  2. If resolved, check previewCache for path \u2192 preview, fetch and cache if missing\n  3. Multiple wikilinks pointing to same note now share same preview data\n\n\u2713 Benefits:\n  - More efficient memory usage (deduplicated preview data)\n  - Separation of concerns (resolution vs content)\n  - Resolution cache can be longer-lived since paths rarely change\n  - Preview cache can be invalidated independently when content changes\n\n\u2713 Committed: ebd8213",
          "files": [
            "frontend/src/lib/markdown.tsx"
          ],
          "updated_at": "2026-01-01T13:43:05.934033+00:00"
        }
      ]
    },
    {
      "id": "phase-3",
      "name": "Preview Card UI Enhancement",
      "description": "Improve the visual design and content of the hover preview card",
      "status": "pending",
      "subtasks": [
        {
          "id": "3.1",
          "title": "Design enhanced preview card layout",
          "description": "Create rich preview card showing: note title (h4), snippet text (max 3 lines), tags as badges (max 3), and 'Updated X ago' footer. Use existing shadcn components",
          "status": "completed",
          "notes": "\u2713 Added formatDistanceToNow() utility function in frontend/src/lib/utils.ts\n\u2713 Enhanced WikilinkPreview component with rich preview card layout:\n  - Note title displayed as h4 with semibold font and tight leading\n  - Snippet text limited to max 3 lines using Tailwind's line-clamp-3 utility\n  - Tags displayed as secondary Badge components (max 3, using slice(0, 3))\n  - Updated timestamp footer with border separator using formatDistanceToNow()\n\u2713 Imported Badge component from shadcn/ui\n\u2713 All content uses existing NotePreview data structure (title, snippet, tags, updated)\n\u2713 Follows existing code patterns and Tailwind CSS conventions\n\u2713 Committed: 28d3098",
          "files": [
            "frontend/src/lib/markdown.tsx"
          ],
          "updated_at": "2026-01-01T13:45:58.036020+00:00"
        },
        {
          "id": "3.2",
          "title": "Improve loading skeleton",
          "description": "Add structured loading skeleton matching the preview card layout (title skeleton, 3 text lines, badge placeholders)",
          "status": "completed",
          "notes": "\u2713 Enhanced loading skeleton with structured layout matching preview card:\n  - Title skeleton: h-5 (larger) with 75% width to match h4 title element\n  - Snippet skeleton: 3 lines (h-3.5 each) with decreasing widths to match line-clamp-3 snippet\n  - Badge placeholders: 2 rounded-full elements (h-5 w-16/w-20) matching tag badge size and shape\n  - Footer skeleton: pt-2 border-t with narrow element (w-32) matching timestamp footer separator\n  \n\u2713 Uses space-y-3 vertical spacing matching the preview card layout\n\u2713 All elements use bg-muted animate-pulse for consistent loading animation\n\u2713 Follows existing code patterns and Tailwind CSS conventions\n\u2713 Committed: 2f3df12",
          "files": [
            "frontend/src/lib/markdown.tsx"
          ],
          "updated_at": "2026-01-01T13:47:49.422870+00:00"
        },
        {
          "id": "3.3",
          "title": "Style broken link indicator",
          "description": "Show distinct card for broken links: red-tinted border, 'Note not found' message, and optional 'Click to create' affordance",
          "status": "completed",
          "notes": "\u2713 Enhanced broken link preview card with distinct styling in frontend/src/lib/markdown.tsx\n\u2713 Added red-tinted border (border-destructive/50) and background (bg-destructive/5) to HoverCardContent when isBroken=true\n\u2713 Created rich broken link card layout matching preview card structure:\n  - Alert icon (SVG circle with exclamation mark) in destructive color\n  - \"Note not found\" heading in destructive color\n  - Explanatory text showing the missing note name\n  - Footer with \"Click to create\" affordance and red-tinted border separator\n\u2713 Follows existing code patterns (Tailwind CSS utilities, space-y-3 layout, consistent with success card)\n\u2713 Maintains visual hierarchy and professional appearance\n\u2713 Committed: 0e25a26",
          "files": [
            "frontend/src/lib/markdown.tsx"
          ],
          "updated_at": "2026-01-01T13:50:32.289467+00:00"
        }
      ]
    },
    {
      "id": "phase-4",
      "name": "UX Polish & Accessibility",
      "description": "Add finishing touches for accessibility, animations, and edge cases",
      "status": "pending",
      "subtasks": [
        {
          "id": "4.1",
          "title": "Keyboard accessibility",
          "description": "Ensure preview cards are accessible: Tab to focus wikilink, Enter to navigate, Escape to dismiss preview. Add ARIA attributes",
          "status": "completed",
          "notes": "\u2713 Added keyboard accessibility support for wikilink preview cards\n\u2713 Preview automatically shows when wikilink receives focus (Tab navigation)\n\u2713 Enter/Space keys navigate to the linked note (existing behavior maintained)\n\u2713 Escape key dismisses preview (Radix UI built-in functionality)\n\u2713 Added comprehensive ARIA attributes:\n  - aria-label on wikilink spans with usage instructions for screen readers\n  - aria-haspopup=\"dialog\" to indicate popup behavior\n  - aria-label on HoverCardContent to describe preview content dynamically\n\u2713 Enhanced broken wikilink renderer with keyboard handlers (Enter/Space to create)\n\u2713 Preview shows on both focus AND hover for better accessibility\n\u2713 Screen reader friendly with descriptive labels explaining interaction\n\u2713 Committed: 167a800",
          "files": [
            "frontend/src/lib/markdown.tsx"
          ],
          "updated_at": "2026-01-01T13:54:12.003475+00:00"
        },
        {
          "id": "4.2",
          "title": "Animation polish",
          "description": "Tune HoverCard open/close animations. Add subtle fade-in for content after loading completes. Match existing app animation patterns",
          "status": "completed",
          "notes": "\u2713 Tuned HoverCard animation timings for smoother transitions\n\u2713 Increased closeDelay from 100ms to 200ms (matches app patterns)\n\u2713 Added animate-fade-in-smooth class to all content states (loading, broken, preview)\n\u2713 Content now fades in smoothly (0.3s ease-in-out) after loading completes\n\u2713 Two-stage animation: HoverCard opens with Radix UI animations, then content fades in\n\u2713 Matches existing app animation patterns from tailwind.config.js\n\u2713 Committed: f6bb363",
          "files": [
            "frontend/src/lib/markdown.tsx"
          ],
          "updated_at": "2026-01-01T13:56:45.861323+00:00"
        },
        {
          "id": "4.3",
          "title": "Touch device handling",
          "description": "On touch devices, long-press to show preview (since hover doesn't work). Use PointerEvents or touch event detection",
          "status": "completed",
          "notes": "\u2713 Added touch device support with long-press functionality using PointerEvents API\n\u2713 Implemented long-press timer (500ms threshold matching openDelay)\n\u2713 Added movement detection to cancel long-press if user scrolls/drags (10px threshold)\n\u2713 Handles pointer events: pointerdown, pointermove, pointerup, pointercancel\n\u2713 Only triggers on touch input (not mouse) via pointerType check\n\u2713 Cleanup effect properly clears timers on unmount\n\u2713 Integrated with existing hover/focus logic - preview shows on hover OR focus OR long-press\n\u2713 Preview dismisses when card closes via handleOpenChange\n\u2713 Follows React patterns (useState, useRef, useEffect)\n\u2713 Proper TypeScript typing for all event handlers\n\u2713 Committed: c8ba1e2",
          "files": [
            "frontend/src/lib/markdown.tsx"
          ],
          "updated_at": "2026-01-01T13:59:48.612167+00:00"
        },
        {
          "id": "4.4",
          "title": "Performance optimization",
          "description": "Add request deduplication (same link hovered multiple times quickly), abort stale requests on hover-out, limit concurrent preview fetches",
          "status": "completed",
          "notes": "✓ Added inflightRequests Map to track and deduplicate ongoing preview fetch requests\n✓ Implemented AbortController to cancel stale requests when hover card closes\n✓ Added fetch queue with MAX_CONCURRENT_FETCHES limit (3 concurrent requests)\n✓ Created processQueue() helper function to manage queue when fetches complete\n✓ Enhanced fetchPreview logic with abort signal checks at each async step\n✓ Prevents redundant API calls when same link hovered multiple times quickly\n✓ Improves performance on notes with many wikilinks by limiting concurrent fetches\n✓ Committed: bc6a663",
          "files": [
            "frontend/src/lib/markdown.tsx"
          ],
          "updated_at": "2026-01-01T15:45:00.000000+00:00"
        }
      ]
    },
    {
      "id": "phase-5",
      "name": "Testing & Validation",
      "description": "End-to-end testing and final validation",
      "status": "pending",
      "subtasks": [
        {
          "id": "5.1",
          "title": "Manual testing checklist",
          "description": "Test: hover shows preview, click navigates, broken links styled, keyboard nav works, fast hover doesn't break, multiple wikilinks on page work",
          "status": "pending",
          "notes": "",
          "files": []
        },
        {
          "id": "5.2",
          "title": "Update build-progress.txt",
          "description": "Document completed work, any known issues, and configuration notes",
          "status": "pending",
          "notes": "",
          "files": [
            ".auto-claude/specs/004-add-hover-preview-cards-for-wikilinks/build-progress.txt"
          ]
        }
      ]
    }
  ],
  "final_acceptance": [
    "Hovering over a wikilink shows a preview card within 500ms",
    "Preview card displays note title, text snippet, and tags",
    "Broken wikilinks show distinct styling and 'not found' message",
    "Clicking a wikilink navigates to the linked note",
    "Preview works on notes with many wikilinks without performance issues",
    "Keyboard navigation works for accessibility"
  ],
  "spec_file": "spec.md",
  "analysis_notes": {
    "existing_implementation": "WikilinkPreview component exists in frontend/src/lib/markdown.tsx using HoverCard from Radix UI",
    "current_issues": [
      "Uses searchNotes() for resolution which may return wrong note",
      "Preview content is basic (150 chars plain text only)",
      "No dedicated backend endpoint for wikilink resolution"
    ],
    "backend_wikilink_resolution": "IndexerService.resolve_wikilinks() in backend uses proper slug-based matching with same-folder preference",
    "key_files": [
      "frontend/src/lib/markdown.tsx - WikilinkPreview component",
      "frontend/src/components/NoteViewer.tsx - uses createWikilinkComponent",
      "frontend/src/components/ui/hover-card.tsx - shadcn HoverCard",
      "backend/src/services/indexer.py - resolve_wikilinks method",
      "backend/src/api/routes/search.py - add resolution endpoint here"
    ]
  },
  "last_updated": "2026-01-01T13:59:48.612177+00:00"
}