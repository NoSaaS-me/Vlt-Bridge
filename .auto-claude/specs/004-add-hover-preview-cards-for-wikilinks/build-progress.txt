# Build Progress: Add Hover Preview Cards for Wikilinks

## Completed Tasks

### ✅ Subtask 1.1: Add wikilink resolution endpoint
**Commit:** 737dc43
**Date:** 2026-01-01

**Implementation Details:**
- Added `IndexerService.resolve_single_wikilink()` method in `backend/src/services/indexer.py`
  - Wraps the existing `resolve_wikilinks()` method for single link resolution
  - Manages database connection lifecycle
  - Returns dict with link_text, target_path (or None), and is_resolved boolean

- Created `GET /api/wikilinks/resolve` endpoint in `backend/src/api/routes/search.py`
  - Query parameters: `link` (required), `context` (optional)
  - Returns `WikilinkResolution` model with link_text, target_path, is_resolved
  - Uses slug-based matching with same-folder preference when context provided
  - Includes proper authentication, URL decoding, and error handling

**Code Pattern Compliance:**
✓ Follows existing IndexerService patterns (connection management, error handling)
✓ Matches search.py endpoint patterns (auth, Query params, HTTPException)
✓ Uses unquote() for URL-encoded parameters
✓ Proper response model with Pydantic BaseModel

**Testing:**
- Manual verification required (backend needs to be started)
- Endpoint accessible at: GET /api/wikilinks/resolve?link={linkText}&context={optional}

### ✅ Subtask 1.2: Add note preview endpoint
**Commit:** 07ff27e
**Date:** 2026-01-01

**Implementation Details:**
- Added `NotePreview` model to `backend/src/models/note.py`
  - Fields: title, snippet (200 chars), tags array, updated timestamp
  - Lightweight model for hover card previews

- Created `_strip_markdown()` helper function in `backend/src/api/routes/notes.py`
  - Removes headers, bold/italic, code blocks, links, wikilinks, images
  - Preserves text content for readable snippets

- Implemented `GET /api/notes/{path}/preview` endpoint in `backend/src/api/routes/notes.py`
  - Returns lightweight preview data
  - Strips markdown from first 200 chars of body
  - Gets tags from metadata first, falls back to database query
  - Properly handles timestamps with ISO parsing
  - Includes proper authentication, URL decoding, and error handling

**Code Pattern Compliance:**
✓ Follows existing notes.py endpoint patterns (auth, path params, HTTPException)
✓ Uses unquote() for URL-encoded paths
✓ Proper response model with Pydantic BaseModel
✓ Consistent timestamp parsing logic
✓ 404 handling for missing notes

---

### ✅ Subtask 1.3: Add unit tests for new endpoints
**Date:** 2026-01-01

**Implementation Details:**
- Created comprehensive test suite in `backend/tests/unit/test_wikilink_api.py`
- 17 test cases covering both endpoints with fixtures and mocks

**Wikilink Resolution Tests (7 tests):**
- ✓ Successful resolution with slug-based matching
- ✓ Resolution with context path (same-folder preference)
- ✓ Broken links (is_resolved=False, target_path=None)
- ✓ Missing link parameter validation (422 error)
- ✓ URL decoding of link text
- ✓ Service error handling (500 error)

**Note Preview Tests (10 tests):**
- ✓ Successful preview retrieval
- ✓ Markdown stripping from snippet (headers, bold, italic, code, links, etc.)
- ✓ Tags from metadata
- ✓ Tags from database fallback
- ✓ Snippet length truncation (200 chars max)
- ✓ Note not found (404 error)
- ✓ URL decoding of note paths
- ✓ Service error handling (500 error)
- ✓ Empty body handling
- ✓ Timestamp parsing

**Code Pattern Compliance:**
✓ Uses FastAPI TestClient
✓ Follows existing test patterns from test_graph_api.py
✓ Uses pytest fixtures for auth and cleanup
✓ Mocks services with patch decorator
✓ Uses app.dependency_overrides for auth injection
✓ Proper cleanup with autouse fixture
✓ Comprehensive edge case coverage

**Testing:**
- Syntax validation passed
- Manual verification required (environment dependency issues prevent full pytest run)

---

### ✅ Subtask 2.1: Add API service functions
**Commit:** 83398ad
**Date:** 2026-01-01

**Implementation Details:**
- Added `WikilinkResolution` and `NotePreview` interfaces to `frontend/src/types/note.ts`
  - WikilinkResolution: link_text, target_path, is_resolved
  - NotePreview: title, snippet, tags, updated
  - Types match backend models

- Added `resolveWikilink(linkText, contextPath?)` function to `frontend/src/services/api.ts`
  - Query parameters: link (required), context (optional)
  - Returns WikilinkResolution from API
  - Uses proper URL encoding for parameters

- Added `getNotePreview(path)` function to `frontend/src/services/api.ts`
  - Path parameter: URL-encoded note path
  - Returns NotePreview from API
  - Uses proper URL encoding for path

**Code Pattern Compliance:**
✓ Follows existing api.ts patterns (apiFetch, URL encoding, JSDoc comments)
✓ Types match backend models exactly
✓ Proper TypeScript type definitions

---

### ✅ Subtask 2.2: Refactor WikilinkPreview to use resolution API
**Commit:** e54a75f
**Date:** 2026-01-01

**Implementation Details:**
- Updated imports in `frontend/src/lib/markdown.tsx`
  - Changed from `getNote, searchNotes` to `resolveWikilink, getNotePreview`
  - Added `NotePreview` type import

- Updated preview cache type from `Map<string, string>` to `Map<string, NotePreview>`
  - Cache now stores structured preview data instead of plain strings

- Updated WikilinkPreview component state
  - Changed `preview` state from `string | null` to `NotePreview | null`

- Refactored `fetchPreview` function flow:
  - First calls `resolveWikilink(linkText)` to get target path
  - Checks `is_resolved` flag and `target_path` existence
  - If not resolved, sets `isBroken=true` and returns early
  - If resolved, calls `getNotePreview(resolution.target_path)`
  - Caches the `NotePreview` object
  - Error handling sets `isBroken=true` for API failures

- Updated preview rendering
  - Changed from displaying plain string to `preview.snippet`
  - Maintains same UI structure (loading skeleton, broken link message)

**Code Pattern Compliance:**
✓ Follows existing React patterns (useState, useEffect, async/await)
✓ Proper TypeScript type annotations
✓ Maintains existing UI components and styling
✓ Two-stage resolution: wikilink → path → preview data
✓ Broken link handling for both resolution failures and API errors

**Benefits:**
- More accurate wikilink resolution using slug-based matching
- Eliminates inefficient search-based resolution
- Structured preview data ready for UI enhancements
- Proper handling of broken links at resolution stage

---

### ✅ Subtask 2.3: Update preview cache strategy
**Commit:** ebd8213
**Date:** 2026-01-01

**Implementation Details:**
- Separated single cache into two distinct caches with different purposes:
  - `resolutionCache: Map<string, string | null>` - maps linkText to resolved note path
  - `previewCache: Map<string, NotePreview>` - maps note path to preview data

- Updated fetchPreview logic in `WikilinkPreview` component:
  - Step 1: Check resolutionCache for linkText → path mapping
    - If not cached, call `resolveWikilink()` and cache the result
    - Cache stores null for broken links
  - Step 2: If path exists, check previewCache for path → preview data
    - If not cached, call `getNotePreview()` and cache the result
  - Multiple wikilinks pointing to the same note now share the same preview data

**Code Pattern Compliance:**
✓ Proper TypeScript type annotations
✓ Maintains existing React patterns (useState, useEffect)
✓ Cache keys properly scoped (linkText for resolution, path for preview)
✓ Non-null assertions used safely with .has() checks

**Benefits:**
- More efficient memory usage (deduplicated preview data for same note)
- Separation of concerns (resolution logic vs content caching)
- Resolution cache can be longer-lived since paths rarely change
- Preview cache can be independently invalidated when note content changes
- Reduces API calls when same note is linked multiple times

---

### ✅ Subtask 3.1: Design enhanced preview card layout
**Commit:** 28d3098
**Date:** 2026-01-01

**Implementation Details:**
- Added `formatDistanceToNow()` utility function to `frontend/src/lib/utils.ts`
  - Converts ISO 8601 timestamps to relative time (e.g., "2 hours ago", "3 days ago")
  - Handles seconds, minutes, hours, days, months, and years
  - Returns "just now" for very recent updates

- Enhanced `WikilinkPreview` component in `frontend/src/lib/markdown.tsx`
  - Imported `Badge` component from shadcn/ui
  - Imported `formatDistanceToNow` utility function
  - Replaced simple snippet text with rich preview card layout

- Rich preview card structure (T031 marker):
  - **Title**: h4 element with semibold font and tight leading
  - **Snippet**: p element with line-clamp-3 (max 3 lines), muted foreground color, relaxed leading
  - **Tags**: Badge components with secondary variant, displayed as flex row (max 3 tags using .slice(0, 3))
  - **Footer**: Timestamp with border-top separator, smaller text, shows "Updated X ago"

**Code Pattern Compliance:**
✓ Uses existing shadcn Badge component
✓ Follows Tailwind CSS utility class patterns
✓ Maintains spacing with space-y-3 for vertical rhythm
✓ Conditional rendering for tags (only shows if tags exist and array is not empty)
✓ TypeScript type safety with NotePreview interface

**UI Design:**
- Clean, hierarchical information display
- Title is most prominent (larger, semibold)
- Snippet text is readable but secondary (muted color, smaller)
- Tags provide visual metadata without overwhelming
- Timestamp anchors the card with context

---

### ✅ Subtask 3.2: Improve loading skeleton
**Commit:** 2f3df12
**Date:** 2026-01-01

**Implementation Details:**
- Enhanced loading skeleton in `frontend/src/lib/markdown.tsx` to match preview card structure
- Replaced simple 3-bar skeleton with structured 4-part layout matching actual content

**Skeleton Structure:**
1. **Title skeleton**
   - Height: h-5 (larger than text to match h4 element)
   - Width: w-3/4 (75% width)
   - Style: bg-muted animate-pulse rounded

2. **Snippet skeleton** (3 text lines)
   - Container: space-y-2 for line spacing
   - Line height: h-3.5 (matching text size)
   - Widths: 100%, 83% (w-5/6), 66% (w-4/6) - decreasing for natural text appearance
   - Style: bg-muted animate-pulse rounded

3. **Badge placeholders** (2 elements)
   - Container: flex gap-1.5 (matching badge layout)
   - Size: h-5 w-16 and h-5 w-20 (matching badge dimensions)
   - Shape: rounded-full (pill-shaped like badges)
   - Style: bg-muted animate-pulse

4. **Footer skeleton**
   - Container: pt-2 border-t (matching timestamp footer separator)
   - Size: h-3 w-32 (small, fixed width for timestamp)
   - Style: bg-muted animate-pulse rounded

**Code Pattern Compliance:**
✓ Uses space-y-3 vertical spacing matching the preview card layout
✓ All elements use consistent bg-muted and animate-pulse classes
✓ Follows Tailwind CSS utility class patterns
✓ Maintains visual hierarchy (title larger, text medium, footer smaller)
✓ Comments document each skeleton section

**UI Benefits:**
- Skeleton now accurately represents final content structure
- Users can anticipate what information will load
- Matches spacing and layout of loaded preview card
- Provides better visual feedback during loading state
- Professional loading experience with attention to detail

---

### ✅ Subtask 3.3: Style broken link indicator
**Commit:** 0e25a26
**Date:** 2026-01-01

**Implementation Details:**
- Enhanced broken link preview card in `frontend/src/lib/markdown.tsx` with distinct styling
- Added conditional className to HoverCardContent component:
  - `border-destructive/50` - red-tinted border for visual distinction
  - `bg-destructive/5` - subtle red background tint

**Broken Link Card Layout** (T033 marker):
1. **Header with icon**
   - Alert icon (SVG circle with exclamation mark) in destructive color
   - "Note not found" heading in h4, semibold, destructive color
   - Flex layout with gap-2 for icon+text alignment

2. **Explanatory text**
   - Shows the missing note name: "The note '{linkText}' does not exist in your vault."
   - Text-sm with muted-foreground color for readability

3. **Footer with affordance**
   - Border-top separator with destructive/20 opacity for subtle red tint
   - "Click the wikilink to create this note" message
   - Text-xs with muted-foreground, pt-2 for spacing

**Code Pattern Compliance:**
✓ Matches preview card layout structure (space-y-3 vertical spacing)
✓ Uses existing shadcn destructive theme color
✓ Inline SVG icon (no external dependencies)
✓ Follows Tailwind CSS utility class patterns
✓ Maintains visual hierarchy (icon+title, body text, footer)
✓ Conditional styling using template literals

**UI Design:**
- Red-tinted border and background clearly distinguish broken links from valid previews
- Alert icon provides immediate visual feedback
- Clear message explains the issue
- Actionable affordance tells users what to do next
- Consistent spacing and typography with success preview card

---

### ✅ Subtask 4.2: Animation polish
**Commit:** f6bb363
**Date:** 2026-01-01

**Implementation Details:**
- Tuned HoverCard animation timings in `frontend/src/lib/markdown.tsx`
  - Increased `closeDelay` from 100ms to 200ms for smoother transitions
  - Kept `openDelay` at 500ms to prevent accidental triggers

- Added `animate-fade-in-smooth` class to all content states:
  - Loading skeleton (with existing `animate-pulse` for skeleton elements)
  - Broken link card (red-tinted error state)
  - Preview card (successful note preview)

- Two-stage animation flow:
  1. HoverCard opens with Radix UI built-in animations (fade + zoom + slide)
  2. Content fades in smoothly with custom animation (0.3s ease-in-out)

**Code Pattern Compliance:**
✓ Uses existing `animate-fade-in-smooth` animation from tailwind.config.js
✓ Matches animation patterns used in NoteViewer component
✓ Consistent with app's duration-200 timing for transitions
✓ Non-intrusive, professional animation that enhances UX without being distracting

**Animation Details:**
- `animate-fade-in-smooth`: 0.3s ease-in-out fade from opacity 0 to 1
- Defined in `frontend/tailwind.config.js` keyframes section
- Same animation used throughout app for content transitions

**UI Benefits:**
- Smoother perceived loading experience
- Content appears gracefully after data fetches
- Consistent with app's overall animation language
- Reduced jarring transitions when switching between states
- Professional, polished feel matching modern web apps

---

### ✅ Subtask 4.3: Touch device handling
**Commit:** c8ba1e2
**Date:** 2026-01-01

**Implementation Details:**
- Added touch device support with long-press functionality using PointerEvents API
- Implemented long-press timer (500ms threshold matching openDelay)
- Added movement detection to cancel long-press if user scrolls/drags (10px threshold)
- Handles pointer events: pointerdown, pointermove, pointerup, pointercancel
- Only triggers on touch input (not mouse) via pointerType check
- Cleanup effect properly clears timers on unmount
- Integrated with existing hover/focus logic - preview shows on hover OR focus OR long-press
- Preview dismisses when card closes via handleOpenChange

**Code Pattern Compliance:**
✓ Follows React patterns (useState, useRef, useEffect)
✓ Proper TypeScript typing for all event handlers
✓ Non-intrusive to existing desktop hover behavior
✓ Cleanup prevents memory leaks

**Benefits:**
- Touch device users can now access preview functionality
- Long-press gesture is intuitive and matches mobile UX patterns
- Movement detection prevents accidental triggers during scrolling
- Seamless integration with existing keyboard and mouse interactions

---

### ✅ Subtask 4.4: Performance optimization
**Commit:** bc6a663
**Date:** 2026-01-01

**Implementation Details:**
- Added `inflightRequests` Map to track and deduplicate ongoing preview fetch requests
  - Maps linkText → Promise<NotePreview | null>
  - Prevents multiple simultaneous requests for the same wikilink
  - Requests in progress are reused when same link hovered quickly

- Implemented `AbortController` for canceling stale requests
  - Creates new AbortController when hover card opens
  - Aborts request when card closes (shouldBeOpen becomes false)
  - Checks abort signal after each async operation
  - Cleanup function aborts controller on unmount

- Added fetch queue with concurrency limiting
  - `MAX_CONCURRENT_FETCHES` set to 3 simultaneous requests
  - `fetchQueue` array holds pending fetch operations
  - `activeFetchCount` tracks current active fetches
  - `processQueue()` helper processes next queued fetch when slot available
  - Completed fetches decrease count and trigger queue processing

- Enhanced `fetchPreview` logic with abort checks
  - Checks `abortController.signal.aborted` after each await
  - Early returns on abort prevent unnecessary state updates
  - Ignores abort errors in catch block
  - Only updates loading state if not aborted

**Code Pattern Compliance:**
✓ Follows React patterns (useRef, useEffect cleanup)
✓ Proper TypeScript typing for all maps and promises
✓ Module-level state for cross-component deduplication
✓ Non-blocking queue processing

**Performance Benefits:**
- Prevents redundant API calls when same link hovered multiple times quickly
- Reduces server load by limiting concurrent requests to 3
- Improves responsiveness by aborting unnecessary in-flight requests
- Efficient memory usage with proper cleanup of inflight request tracking
- Scales well on notes with many wikilinks (10+)

**Testing:**
- TypeScript compilation successful (no syntax errors)
- Ready for manual testing with notes containing multiple wikilinks

---

## In Progress

None

---

## Pending Tasks

### Phase 1: Backend API Enhancements
✅ All subtasks completed!

### Phase 2: Frontend API Integration
✅ All subtasks completed!

### Phase 3: Preview Card UI Enhancement
✅ All subtasks completed!

### Phase 4: UX Polish & Accessibility
- [x] 4.1: Keyboard accessibility
- [x] 4.2: Animation polish
- [x] 4.3: Touch device handling
- [x] 4.4: Performance optimization

### Phase 5: Testing & Validation
- [ ] 5.1: Manual testing checklist
- [ ] 5.2: Update build-progress.txt

---

## Notes

- The new endpoint uses the existing `IndexerService.resolve_wikilinks()` which implements the slug-based matching algorithm with same-folder preference
- No breaking changes to existing code
- Ready for frontend integration in Phase 2
